<!DOCTYPE html>
<html lang="pt-BR" data-theme="light" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(~{::title}, ~{::main}, ~{::pageScripts})}">
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"
      integrity="sha384-jLKHWMZt7qdqQb+K0g3u9q3v7Dq4r6c8xvH6q2wCk1cG5b5c2a/4z9q9b4q7qz7Z"
      crossorigin="anonymous">
<head>
</head>
<body>
<main class="flex-grow p-6 bg-[#242529] overflow-y-auto">
    <div th:if="${message}" class="alert alert-success shadow-lg max-w-xl mx-auto rounded-xl" role="alert" id="success-alert">
        <div class="flex items-center space-x-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span th:text="${message}">Ação realizada com sucesso!</span>
        </div>
    </div>

    <h2 class="text-2xl font-bold mb-6 text-white" th:text="#{dashboard.heading}">
        Dashboard da Aplicação
    </h2>


    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Usuários -->
        <section class="bg-gray-800 border border-gray-700 shadow-lg rounded-xl p-6" aria-labelledby="card-usuarios">
            <h3 id="card-usuarios" class="font-semibold text-lg mb-2 text-white" th:text="#{dashboard.users.title}">
                Novos Cadastros nos Últimos 6 Meses
            </h3>
            <p class="text-gray-400 mb-4" th:text="#{dashboard.users.subtitle}">
                Acompanhe o crescimento da base de usuários.
            </p>

            <div class="flex items-center mb-4">
                <span class="text-3xl font-bold text-[var(--color-primary)] mr-2" aria-hidden="true">
                    <i class="fa-solid fa-users"></i>
                </span>
                <div>
                    <div class="text-3xl font-bold text-white">
                        <span th:text="${totalUsers}">1,234</span>
                    </div>
                    <div class="text-gray-400" th:text="#{dashboard.users.total}">Total de Usuários</div>
                </div>
            </div>

            <div class="w-full">
                <canvas id="usuariosChart" class="w-full h-56"
                        role="img" th:attr="aria-label=#{dashboard.users.chart.label}">
                </canvas>
            </div>
        </section>

        <article class="bg-gray-800 border border-gray-700 shadow-lg rounded-xl p-6 cursor-pointer hover:shadow-[0_0_15px_rgba(0,177,49,0.5)] transition"
                 th:onclick="|window.location.href='@{/monitoramento}'|" aria-labelledby="card-filiais">
            <h3 id="card-filiais" class="font-semibold text-lg mb-2 text-white" th:text="#{dashboard.branches.title}">
                Status das Filiais Cadastradas
            </h3>
            <p class="text-gray-400 mb-4" th:text="#{dashboard.branches.subtitle}">
                Visão geral do estado operacional de cada filial.
            </p>

            <div class="flex items-center mb-4">
                <span class="text-3xl font-bold text-[var(--color-primary)] mr-2" aria-hidden="true">
                    <i class="fa-solid fa-location-dot"></i>
                </span>
                <div>
                    <div class="text-3xl font-bold text-white">
                        <span th:text="${totalFiliais}">56</span>
                    </div>
                    <div class="text-gray-400" th:text="#{dashboard.branches.total}">Total de Filiais</div>
                </div>
            </div>

            <div class="w-full">
                <canvas id="filiaisChart" class="w-full h-56"
                        role="img" th:attr="aria-label=#{dashboard.branches.chart.label}">
                </canvas>
            </div>
        </article>

        <!-- Motos Ativas -->
        <section class="bg-gray-800 border border-gray-700 shadow-lg rounded-xl p-6" aria-labelledby="card-motos-ativas">
            <h3 id="card-motos-ativas" class="font-semibold text-lg mb-2 text-white" th:text="#{dashboard.bikes.active.title}">
                Motos Ativas por Modelo
            </h3>
            <p class="text-gray-400 mb-4" th:text="#{dashboard.bikes.active.subtitle}">
                Distribuição de motos Mottu por modelo.
            </p>
            <div class="w-full">
                <canvas id="motosAtivasChart" class="w-full h-56"
                        role="img" th:attr="aria-label=#{dashboard.bikes.active.chart.label}">
                </canvas>
            </div>
        </section>

        <!-- Motos no Pátio -->
        <section class="bg-gray-800 border border-gray-700 shadow-lg rounded-xl p-6 md:col-span-2 lg:col-span-1"
                 aria-labelledby="card-motos-patio">
            <h3 id="card-motos-patio" class="font-semibold text-lg mb-2 text-white" th:text="#{dashboard.bikes.yard.title}">
                Motos: No Pátio vs. Em Uso
            </h3>
            <p class="text-gray-400 mb-4" th:text="#{dashboard.bikes.yard.subtitle}">
                Proporção de motos disponíveis vs. em serviço.
            </p>

            <div class="flex justify-around items-center my-6 text-white">
                <div class="text-center">
            <span class="text-3xl font-bold text-[var(--color-primary)]" aria-hidden="true">
                <i class="fa-solid fa-square-check"></i>
            </span>
                    <div class="text-3xl font-bold" th:text="${motosNoPatio}">0</div>
                    <div class="text-gray-400 text-sm">Disponíveis</div>
                </div>
                <div class="text-center">
            <span class="text-3xl font-bold text-red-500" aria-hidden="true">
                <i class="fa-solid fa-motorcycle"></i>
            </span>
                    <div class="text-3xl font-bold" th:text="${motosForaDoPatio}">0</div>
                    <div class="text-gray-400 text-sm">Em Uso</div>
                </div>
            </div>
            <div class="w-full flex justify-center">
                <canvas id="motosPatioChart" class="w-full h-56 max-w-xs"
                        role="img" th:attr="aria-label=#{dashboard.bikes.yard.chart.label}">
                </canvas>
            </div>
        </section>

    </div>
</main>
<th:block th:fragment="pageScripts">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Dados esperados (sem alteração)
        const usuariosLabels = /*[[${usuariosLabels}]]*/ [];
        const usuariosData = /*[[${usuariosData}]]*/ [];
        const filiaisLabels = /*[[${filiaisLabels}]]*/ [];
        const filiaisData = /*[[${filiaisData}]]*/ [];
        const motosAtivasLabels = /*[[${motosAtivasLabels}]]*/ [];
        const motosAtivasData = /*[[${motosAtivasData}]]*/ [];
        const patiosLabels = /*[[${patiosLabels}]]*/ [];
        const patiosData = /*[[${patiosData}]]*/ [];

        // Função createChart
        function createChart(ctxId, labels, data, label, type = 'line', options = {}){
          const ctx = document.getElementById(ctxId);
          if(!ctx) return null;

          // CORRIGIDO: Adicionando 'precision' e 'stepSize' para números inteiros
          const defaultOptions = {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                x: { grid: { display: false }, ticks: { color: '#cbd5e1' } },
                y: {
                    grid: { color: 'rgba(255,255,250,0.04)' },
                    ticks: {
                        color: '#cbd5e1',
                        beginAtZero: true,
                        precision: 0,  // Garante números inteiros
                        stepSize: 1    // Força o passo a ser 1
                    }
                }
              }
          };

          // Merge (sem alteração)
          const mergedOptions = { ...defaultOptions, ...options };
          if (options.plugins && options.plugins.legend) {
              mergedOptions.plugins.legend = { ...defaultOptions.plugins.legend, ...options.plugins.legend };
          }
          if (options.scales) {
              mergedOptions.scales = { ...defaultOptions.scales, ...options.scales };
              if (options.scales.x) mergedOptions.scales.x = { ...defaultOptions.scales.x, ...options.scales.x };
              if (options.scales.y) mergedOptions.scales.y = { ...defaultOptions.scales.y, ...options.scales.y };
          }


          const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim() || '#00b131';
          const dangerColor = '#ff6666';

          // Dataset config (sem alteração)
          const datasetConfig = {
            label: label,
            data: data,
            fill: (type === 'line'),
            tension: (type === 'line') ? 0.3 : 0,
            borderWidth: (type === 'bar' || type === 'line') ? 2 : 0,
            pointRadius: (type === 'line') ? 3 : 0,
          };

          if (type === 'pie') {
              datasetConfig.backgroundColor = [ primaryColor, dangerColor ];
              datasetConfig.borderColor = 'transparent';
          } else if (type === 'bar') {
              datasetConfig.backgroundColor = 'rgba(0,177,49,0.7)';
              datasetConfig.borderColor = primaryColor;
          } else {
              datasetConfig.borderColor = primaryColor;
              datasetConfig.backgroundColor = 'rgba(0,177,49,0.12)';
          }

          return new Chart(ctx, {
            type: type,
            data: { labels: labels, datasets: [datasetConfig] },
            options: mergedOptions
          });
        }

        // Gráfico de Usuários (sem alteração, usará 'defaultOptions' corrigido)
        if(usuariosLabels.length && usuariosData.length){
          createChart('usuariosChart', usuariosLabels, usuariosData, 'Cadastros');
        } else {
          createChart('usuariosChart', ['Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set'], [0, 0, 0, 0, 0, 0], 'Cadastros');
        }

        // Gráfico de Filiais (sem alteração, usará 'defaultOptions' corrigido)
        if(filiaisLabels.length && filiaisData.length){
          createChart('filiaisChart', filiaisLabels, filiaisData, 'Filiais', 'bar');
        } else {
          createChart('filiaisChart', ['SP', 'RJ', 'MG', 'BA', 'PR'], [0, 0, 0, 0, 0], 'Filiais', 'bar');
        }

        // Gráfico Motos Ativas (CORRIGIDO: 'scales' com 'precision')
        const motosAtivasChartOptions = {
            plugins: {
                legend: { display: true, position: 'top', labels: { color: '#cbd5e1' } }
            },
            scales: {
                x: { grid: { display: false }, ticks: { color: '#cbd5e1' } },
                y: {
                    grid: { color: 'rgba(255,255,250,0.04)' },
                    ticks: {
                        color: '#cbd5e1',
                        beginAtZero: true,
                        precision: 0, // Garante números inteiros
                        stepSize: 1   // Força o passo a ser 1
                    }
                }
            }
        };
        if(motosAtivasLabels.length && motosAtivasData.length){
            createChart('motosAtivasChart', motosAtivasLabels, motosAtivasData, 'Motos Ativas', 'bar', motosAtivasChartOptions);
        } else {
            createChart('motosAtivasChart', ['MottuPop', 'MottuE', 'MottuSport'], [0, 0, 0], 'Motos Ativas', 'bar', motosAtivasChartOptions);
        }

        const motosPatioChartOptions = {
            plugins: {
                legend: { display: true, position: 'right', labels: { color: '#cbd5e1', usePointStyle: true } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) { label += ': '; }
                            if (context.parsed !== null) { label += context.parsed + ' motos'; }
                            return label;
                        }
                    }
                }
            },
            scales: { x: { display: false }, y: { display: false } }
        };

        // A lógica de atualizar os contadores foi REMOVIDA
        // O Thymeleaf já fez isso no servidor

        if(patiosLabels.length && patiosData.length > 0 && (patiosData[0] > 0 || patiosData[1] > 0)){
            createChart('motosPatioChart', patiosLabels, patiosData, 'Status Pátio', 'pie', motosPatioChartOptions);
        } else {
            createChart('motosPatioChart', ['No Pátio', 'Fora do Pátio'], [0, 0], 'Status Pátio', 'pie', motosPatioChartOptions);
        }

        /*]]>*/
    </script>
    <script>
        // Script do Alerta (sem alteração)
        document.addEventListener("DOMContentLoaded", function() {
            const alertElement = document.getElementById('success-alert');
            if (alertElement) {
                alertElement.style.transition = 'opacity 0.5s ease-out';
                setTimeout(() => {
                    alertElement.style.opacity = '0';
                    setTimeout(() => {
                        alertElement.remove();
                    }, 500);
                }, 5000);
            }
        });
    </script>
</th:block>
</body>
</html>