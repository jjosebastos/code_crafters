<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(null, ~{::main}, ~{::scripts})}"> <head>
    <meta charset="UTF-8">
    <title>Rastreamento em Tempo Real</title>

    <th:block th:fragment="styles"></th:block>

</head>
<body>
<main th:fragment="main" class="flex-grow p-6 bg-[#1e1f24] min-h-screen">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        #map { height: 70vh; width: 100%; border-radius: 0.5rem; border: 1px solid #4B5563; }
    </style>
    <div class="mb-6 border-b border-gray-700 pb-3 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-[var(--color-primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <h2 class="text-2xl font-bold text-white" th:text="#{tracking.title}">Rastreamento em Tempo Real</h2>
    </div>

    <div id="map" class="shadow-lg bg-gray-800"></div>

</main>

<th:block th:fragment="scripts">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/

        var translations = {
            placa: [[#{tracking.popup.placa}]],
            modelo: [[#{tracking.popup.modelo}]],
            status: [[#{tracking.popup.status}]],
            lat: [[#{tracking.popup.lat}]],
            lon: [[#{tracking.popup.lon}]],

            // Lista de todos os status possíveis vindos do Node-RED
            'moto.alerta.zona_segura_nao_estacionada': [[#{moto.alerta.zona_segura_nao_estacionada}]],
            'moto.status.ok': [[#{moto.status.ok}]],
            'moto.status.em_movimento': [[#{moto.status.em_movimento}]]
        };

        // 2. Função para traduzir a chave de status que vem do WebSocket
        function getTranslatedStatus(statusKey) {
            // Se a chave (ex: "moto.status.ok") existir, retorna a tradução.
            // Senão, retorna a própria chave (que pode ser um texto antigo).
            return translations[statusKey] || statusKey;
        }



        console.log("Iniciando página de rastreamento...");

        var map = null;
        var motoMarkers = {};

        function inicializarMapa() {
            console.log("Inicializando mapa Leaflet...");
            try {
                map = L.map('map').setView([-23.5505, -46.6333], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                console.log("Mapa inicializado com sucesso.");
            } catch (e) {
                console.error("Erro ao inicializar o mapa:", e);
                document.getElementById('map').innerHTML = '<p class="text-red-500 p-4">Erro ao carregar o mapa.</p>';
            }
        }

        function atualizarMarcadorMoto(moto) {
            if (!map || !moto || !moto.idMoto || moto.latitude == null || moto.longitude == null) {
                 console.warn("Mapa não inicializado ou dados da moto inválidos:", moto);
                 return;
            }

            var motoId = moto.idMoto;
            var lat = moto.latitude;
            var lon = moto.longitude;
            var latLng = L.latLng(lat, lon);

            var popupContent = `
                <div style="color: #333; line-height: 1.5;">
                    <b>${translations.placa}:</b> ${moto.nrPlaca || '-'}<br>
                    <b>${translations.modelo}:</b> ${moto.nmModelo || '-'}<br>
                    <b>${translations.status}:</b> ${getTranslatedStatus(moto.dsStatus)}<br>
                    <b>${translations.lat}:</b> ${lat.toFixed(6)}<br>
                    <b>${translations.lon}:</b> ${lon.toFixed(6)}
                </div>
            `;

            if (motoMarkers[motoId]) {
                console.log("Movendo marcador para moto:", motoId);
                motoMarkers[motoId].setLatLng(latLng);
                motoMarkers[motoId].setPopupContent(popupContent);
            } else {
                console.log("Criando novo marcador para moto:", motoId);
                var marker = L.marker(latLng).addTo(map)
                    .bindPopup(popupContent);
                motoMarkers[motoId] = marker;
            }
        }

        var stompClientMap = null;

        function connectMapWebSocket() {
            var socket = new SockJS(/*[[@{/ws-patios}]]*/ '/ws-patios');
            stompClientMap = Stomp.over(socket);
            stompClientMap.debug = null;

            stompClientMap.connect({}, function (frame) {
                console.log('Conectado ao WebSocket Mapa: ' + frame);
                stompClientMap.subscribe('/topic/map-updates', function (message) {
                    console.log('Recebido /topic/map-updates: ' + message.body);
                    try {
                        var motoAtualizada = JSON.parse(message.body);
                        atualizarMarcadorMoto(motoAtualizada);
                    } catch (e) {
                        console.error("Erro ao processar mensagem JSON da moto:", e, message.body);
                    }
                });
            }, function(error) {
                console.error('Erro na conexão WebSocket Mapa: ' + error + ". Tentando reconectar em 5 segundos.");
                setTimeout(connectMapWebSocket, 5000);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            inicializarMapa();
            connectMapWebSocket();
        });

        /*]]>*/
    </script>
</th:block>

</body>
</html>