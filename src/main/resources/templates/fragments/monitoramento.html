<!DOCTYPE html>
<html lang="pt-BR" data-theme="light" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(~{::title}, ~{::main}, ~{::scripts})}">
<head>
    <title>Monitoramento de Pátio</title>
</head>
<body>
<main class="flex-grow p-6 bg-[#242529] overflow-y-auto">
    <h2 class="text-2xl font-bold mb-6 text-white">Monitoramento de Pátio</h2>

    <div class="mb-6">
        <label for="patio-select" class="block text-white mb-2">Selecione um Pátio:</label>
        <select id="patio-select" class="w-full md:w-1/2 lg:w-1/3 p-2 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]"
                onchange="loadPatioLayout()" th:object="${patios}">
            <option value="">-- Escolha um Pátio --</option>
            <option th:each="patio : ${patios}"
                    th:value="${patio.idPatio}"
                    th:text="${patio.nmPatio}"></option>
        </select>
    </div>

    <div id="patio-summary" class="hidden bg-gray-800 border border-gray-700 shadow-lg rounded-xl p-6 mb-6">
        <h3 class="font-semibold text-lg mb-2 text-white">Resumo do Pátio</h3>
        <p class="text-gray-400">Pátio: <span id="patio-name" class="font-bold text-white"></span></p>
        <p class="text-gray-400">Total de Vagas: <span id="total-vagas" class="font-bold text-white"></span></p>
        <p class="text-gray-400">Vagas Ocupadas: <span id="vagas-ocupadas" class="font-bold text-white"></span></p>
        <p class="text-gray-400">Vagas Livres: <span id="vagas-livres" class="font-bold text-white"></span></p>
    </div>

    <div id="patio-grid-container" class="mt-6">
    </div>
</main>

<script th:inline="javascript" th:fragment="scripts">
    /*<![CDATA[*/

    const patioSelect = document.getElementById('patio-select');
    const patioGridContainer = document.getElementById('patio-grid-container');
    const patioSummary = document.getElementById('patio-summary');

    async function loadPatioLayout() {
        const patioId = patioSelect.value;
        if (!patioId) {
            patioGridContainer.innerHTML = '';
            patioSummary.classList.add('hidden');
            return;
        }

        try {
            // Faz a requisição ao seu endpoint que retorna os dados do pátio
            const response = await fetch(`/api/monitoramento/patio/${patioId}`);
            if (!response.ok) {
                throw new Error('Erro ao buscar dados do pátio.');
            }
            const data = await response.json();

            // Atualiza o resumo
            patioSummary.classList.remove('hidden');
            document.getElementById('patio-name').textContent = data.nmPatio;
            document.getElementById('total-vagas').textContent = data.totalVagas;
            document.getElementById('vagas-ocupadas').textContent = data.vagasOcupadas;
            document.getElementById('vagas-livres').textContent = data.vagasLivres;

            // Renderiza o layout da grade
            renderPatioGrid(data.vagas);

        } catch (error) {
            console.error('Falha ao carregar o layout do pátio:', error);
            patioGridContainer.innerHTML = `<p class="text-red-500">Erro: Não foi possível carregar o layout do pátio. Tente novamente mais tarde.</p>`;
        }
    }

    function renderPatioGrid(vagas) {
        let gridHtml = `<div class="grid grid-cols-10 md:grid-cols-20 xl:grid-cols-25 gap-2">`;

        vagas.forEach(vaga => {
            let vagaClasses = "p-2 rounded-lg text-white font-bold text-xs flex items-center justify-center relative";
            let content = '';
            let details = '';

            // Lógica para definir a cor e o conteúdo com base no status da vaga
            if (vaga.status === 'OCUPADA') {
                vagaClasses += " bg-[var(--color-primary)] cursor-pointer hover:bg-green-600 transition";
                content = `<span>${vaga.nrVaga}</span>`;
                details = `<div class="absolute inset-0 bg-black bg-opacity-70 p-1 rounded-lg opacity-0 hover:opacity-100 transition-opacity flex flex-col items-center justify-center text-center">
                               <p class="text-xs">Placa: ${vaga.moto.placa}</p>
                               <p class="text-xs">Modelo: ${vaga.moto.modelo}</p>
                           </div>`;
            } else if (vaga.status === 'LIVRE') {
                vagaClasses += " bg-gray-700 cursor-pointer hover:bg-gray-600 transition";
                content = `<span>${vaga.nrVaga}</span>`;
            } else { // 'INDISPONIVEL'
                vagaClasses += " bg-gray-900 cursor-not-allowed";
                content = `<span>--</span>`;
            }

            gridHtml += `<div class="${vagaClasses}">
                            ${content}
                            ${details}
                         </div>`;
        });

        gridHtml += `</div>`;
        patioGridContainer.innerHTML = gridHtml;
    }

    /*]]>*/
</script>
</body>
</html>